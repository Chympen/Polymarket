generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x", "rhel-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ────────────────────────────────────────
// Markets
// ────────────────────────────────────────
model Market {
  id                String   @id @default(uuid())
  conditionId       String   @unique @map("condition_id")
  questionId        String   @map("question_id")
  slug              String?
  question          String
  description       String?
  outcomeYes        String   @default("Yes") @map("outcome_yes")
  outcomeNo         String   @default("No") @map("outcome_no")
  priceYes          Float    @default(0.5) @map("price_yes")
  priceNo           Float    @default(0.5) @map("price_no")
  volume24h         Float    @default(0) @map("volume_24h")
  liquidity         Float    @default(0)
  endDate           DateTime? @map("end_date")
  resolved          Boolean  @default(false)
  resolutionOutcome String?  @map("resolution_outcome")
  active            Boolean  @default(true)
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  trades      Trade[]
  positions   Position[]
  aiDecisions AiDecision[]

  @@map("markets")
}

// ────────────────────────────────────────
// Trades
// ────────────────────────────────────────
model Trade {
  id              String   @id @default(uuid())
  marketId        String   @map("market_id")
  side            String   // YES | NO
  type            String   // MARKET | LIMIT
  direction       String   // BUY | SELL
  sizeUsd         Float    @map("size_usd")
  price           Float
  filledPrice     Float?   @map("filled_price")
  filledSizeUsd   Float?   @map("filled_size_usd")
  slippage        Float?
  gasUsed         Float?   @map("gas_used")
  txHash          String?  @map("tx_hash")
  status          String   @default("PENDING") // PENDING | SUBMITTED | FILLED | FAILED | CANCELLED
  strategyId      String?  @map("strategy_id")
  confidence      Float?
  reasoning       String?
  errorMessage    String?  @map("error_message")
  retryCount      Int      @default(0) @map("retry_count")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  market Market @relation(fields: [marketId], references: [id])

  @@index([marketId])
  @@index([status])
  @@index([createdAt])
  @@map("trades")
}

// ────────────────────────────────────────
// Positions
// ────────────────────────────────────────
model Position {
  id              String   @id @default(uuid())
  marketId        String   @map("market_id")
  side            String   // YES | NO
  sizeUsd         Float    @map("size_usd")
  avgEntryPrice   Float    @map("avg_entry_price")
  currentPrice    Float    @default(0) @map("current_price")
  unrealizedPnl   Float    @default(0) @map("unrealized_pnl")
  realizedPnl     Float    @default(0) @map("realized_pnl")
  status          String   @default("OPEN") // OPEN | CLOSED | LIQUIDATED
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  market Market @relation(fields: [marketId], references: [id])

  @@unique([marketId, side])
  @@index([status])
  @@map("positions")
}

// ────────────────────────────────────────
// Portfolio
// ────────────────────────────────────────
model Portfolio {
  id                  String   @id @default(uuid())
  totalCapital        Float    @map("total_capital")
  availableCapital    Float    @map("available_capital")
  deployedCapital     Float    @map("deployed_capital")
  totalPnl            Float    @default(0) @map("total_pnl")
  dailyPnl            Float    @default(0) @map("daily_pnl")
  dailyPnlPercent     Float    @default(0) @map("daily_pnl_percent")
  highWaterMark       Float    @default(0) @map("high_water_mark")
  maxDrawdown         Float    @default(0) @map("max_drawdown")
  killSwitchActive    Boolean  @default(false) @map("kill_switch_active")
  capitalPreservation Boolean  @default(false) @map("capital_preservation")
  snapshotDate        DateTime @default(now()) @map("snapshot_date")
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")

  @@index([snapshotDate])
  @@map("portfolio")
}

// ────────────────────────────────────────
// AI Decisions
// ────────────────────────────────────────
model AiDecision {
  id              String   @id @default(uuid())
  marketId        String   @map("market_id")
  strategyId      String   @map("strategy_id")
  trade           Boolean
  side            String?  // YES | NO
  confidence      Float
  positionSizeUsd Float?   @map("position_size_usd")
  reasoning       String?
  inputSnapshot   Json?    @map("input_snapshot")
  promptUsed      String?  @map("prompt_used")
  llmModel        String?  @map("llm_model")
  llmLatencyMs    Int?     @map("llm_latency_ms")
  approved        Boolean  @default(false)
  executedTradeId String?  @map("executed_trade_id")
  createdAt       DateTime @default(now()) @map("created_at")

  market Market @relation(fields: [marketId], references: [id])

  @@index([marketId])
  @@index([strategyId])
  @@index([createdAt])
  @@map("ai_decisions")
}

// ────────────────────────────────────────
// Strategy Scores
// ────────────────────────────────────────
model StrategyScore {
  id              String   @id @default(uuid())
  strategyId      String   @map("strategy_id")
  strategyName    String   @map("strategy_name")
  winRate         Float    @default(0) @map("win_rate")
  totalTrades     Int      @default(0) @map("total_trades")
  totalPnl        Float    @default(0) @map("total_pnl")
  sharpeRatio     Float    @default(0) @map("sharpe_ratio")
  maxDrawdown     Float    @default(0) @map("max_drawdown")
  avgConfidence   Float    @default(0) @map("avg_confidence")
  calScoreConf    Float    @default(0) @map("cal_score_conf") // calibration score
  weight          Float    @default(1.0)
  active          Boolean  @default(true)
  scoredAt        DateTime @default(now()) @map("scored_at")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  @@index([strategyId])
  @@map("strategy_scores")
}

// ────────────────────────────────────────
// Performance Metrics
// ────────────────────────────────────────
model PerformanceMetric {
  id              String   @id @default(uuid())
  metricDate      DateTime @map("metric_date")
  totalPnl        Float    @default(0) @map("total_pnl")
  dailyPnl        Float    @default(0) @map("daily_pnl")
  sharpeRatio     Float    @default(0) @map("sharpe_ratio")
  maxDrawdown     Float    @default(0) @map("max_drawdown")
  winRate         Float    @default(0) @map("win_rate")
  totalTrades     Int      @default(0) @map("total_trades")
  tradeAccuracy   Float    @default(0) @map("trade_accuracy")
  avgConfidence   Float    @default(0) @map("avg_confidence")
  portfolioValue  Float    @default(0) @map("portfolio_value")
  deployedPercent Float    @default(0) @map("deployed_percent")
  createdAt       DateTime @default(now()) @map("created_at")

  @@unique([metricDate])
  @@map("performance_metrics")
}

// ────────────────────────────────────────
// Risk Events
// ────────────────────────────────────────
model RiskEvent {
  id              String   @id @default(uuid())
  eventType       String   @map("event_type") // DRAWDOWN_BREACH | EXPOSURE_BREACH | SIZE_REJECT | KILL_SWITCH | CAPITAL_PRESERVATION
  severity        String   // LOW | MEDIUM | HIGH | CRITICAL
  message         String
  details         Json?
  tradeId         String?  @map("trade_id")
  marketId        String?  @map("market_id")
  resolved        Boolean  @default(false)
  resolvedAt      DateTime? @map("resolved_at")
  createdAt       DateTime @default(now()) @map("created_at")

  @@index([eventType])
  @@index([severity])
  @@index([createdAt])
  @@map("risk_events")
}

// ────────────────────────────────────────
// Budget Configuration (singleton)
// ────────────────────────────────────────
model BudgetConfig {
  id                    String   @id @default(uuid())
  maxDailyAiSpend       Float    @default(10.0) @map("max_daily_ai_spend")
  maxMonthlyAiSpend     Float    @default(200.0) @map("max_monthly_ai_spend")
  maxTotalTradeSpend    Float    @default(1000.0) @map("max_total_trade_spend")
  maxTradeSize          Float    @default(50.0) @map("max_trade_size")
  alertThresholdPercent Float    @default(80.0) @map("alert_threshold_percent")
  aiSpendingPaused      Boolean  @default(false) @map("ai_spending_paused")
  createdAt             DateTime @default(now()) @map("created_at")
  updatedAt             DateTime @updatedAt @map("updated_at")

  @@map("budget_config")
}

// ────────────────────────────────────────
// AI Cost Log
// ────────────────────────────────────────
model AiCostLog {
  id                String   @id @default(uuid())
  model             String
  promptTokens      Int      @default(0) @map("prompt_tokens")
  completionTokens  Int      @default(0) @map("completion_tokens")
  totalTokens       Int      @default(0) @map("total_tokens")
  costUsd           Float    @default(0) @map("cost_usd")
  purpose           String   // trade_decision | market_analysis | sentiment | portfolio_optimization
  relatedMarketId   String?  @map("related_market_id")
  relatedDecisionId String?  @map("related_decision_id")
  durationMs        Int?     @map("duration_ms")
  createdAt         DateTime @default(now()) @map("created_at")

  @@index([createdAt])
  @@index([purpose])
  @@map("ai_cost_log")
}
// ────────────────────────────────────────
// Activity Log
// ────────────────────────────────────────
model ActivityLog {
  id        String   @id @default(uuid())
  level     String   @default("INFO") // INFO | SUCCESS | WARN | ERROR | TRADE
  type      String   @default("SYSTEM") // SYSTEM | ANALYSIS | RISK | EXECUTION
  message   String
  details   Json?
  createdAt DateTime @default(now()) @map("created_at")

  @@index([createdAt])
  @@index([type])
  @@map("activity_log")
}

// ────────────────────────────────────────
// Trade Outcomes (Feedback Loop)
// ────────────────────────────────────────
model TradeOutcome {
  id              String   @id @default(uuid())
  tradeId         String   @map("trade_id")
  marketId        String   @map("market_id")
  strategyId      String   @map("strategy_id")
  side            String   // YES | NO
  entryPrice      Float    @map("entry_price")
  exitPrice       Float?   @map("exit_price")
  pnlUsd          Float    @default(0) @map("pnl_usd")
  pnlPercent      Float    @default(0) @map("pnl_percent")
  outcome         String   @default("PENDING") // PENDING | WIN | LOSS | BREAKEVEN
  resolvedAt      DateTime? @map("resolved_at")
  originalReasoning String? @map("original_reasoning")
  marketQuestion  String?  @map("market_question")
  lessonsLearned  String?  @map("lessons_learned")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  @@index([strategyId])
  @@index([outcome])
  @@index([createdAt])
  @@map("trade_outcomes")
}

// ────────────────────────────────────────
// Correction Notes (Post-Mortem)
// ────────────────────────────────────────
model CorrectionNote {
  id                String   @id @default(uuid())
  tradeOutcomeId    String   @map("trade_outcome_id")
  marketQuestion    String   @map("market_question")
  originalReasoning String   @map("original_reasoning")
  whatWentWrong     String   @map("what_went_wrong")
  correctionRule    String   @map("correction_rule")
  severity          String   @default("MEDIUM") // LOW | MEDIUM | HIGH
  strategyId        String   @map("strategy_id")
  category          String?  // e.g., OVERCONFIDENCE | BAD_TIMING | IGNORED_RISK | SENTIMENT_BIAS
  active            Boolean  @default(true)
  appliedCount      Int      @default(0) @map("applied_count")
  createdAt         DateTime @default(now()) @map("created_at")

  @@index([strategyId])
  @@index([active])
  @@index([category])
  @@map("correction_notes")
}

// ────────────────────────────────────────
// Market Clusters (Correlation Awareness)
// ────────────────────────────────────────
model MarketCluster {
  id              String   @id @default(uuid())
  clusterName     String   @map("cluster_name")
  description     String?
  marketIds       Json     @map("market_ids") // Array of condition IDs
  totalExposure   Float    @default(0) @map("total_exposure")
  maxExposure     Float    @default(500) @map("max_exposure")
  correlationScore Float   @default(0) @map("correlation_score")
  active          Boolean  @default(true)
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  @@index([clusterName])
  @@map("market_clusters")
}

// ────────────────────────────────────────
// Market Regime Snapshots
// ────────────────────────────────────────
model MarketRegimeSnapshot {
  id              String   @id @default(uuid())
  regime          String   // STABLE_RANGE | VOLATILE_TREND | LOW_LIQUIDITY | HIGH_MOMENTUM | MEAN_REVERTING
  confidence      Float    @default(0)
  avgVolatility   Float    @default(0) @map("avg_volatility")
  avgTrendStrength Float   @default(0) @map("avg_trend_strength")
  avgLiquidity    Float    @default(0) @map("avg_liquidity")
  marketsSampled  Int      @default(0) @map("markets_sampled")
  strategyMultipliers Json? @map("strategy_multipliers") // { "momentum": 1.5, "mean-reversion": 0.8, ... }
  details         Json?
  snapshotDate    DateTime @default(now()) @map("snapshot_date")
  createdAt       DateTime @default(now()) @map("created_at")

  @@index([snapshotDate])
  @@index([regime])
  @@map("market_regime_snapshots")
}
